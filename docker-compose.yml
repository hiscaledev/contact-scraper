services:
  redis:
    image: redis:8.4.0-alpine
    container_name: contact-scraper-redis
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    command: >
      sh -c '
      if [ -n "$${REDIS_PASSWORD}" ]; then
        redis-server --appendonly yes --requirepass "$${REDIS_PASSWORD}"
      else
        redis-server --appendonly yes
      fi
      '
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: contact-scraper
    # Optional local port mapping, Traefik will handle SSL routing
    ports:
      - "8000:8000"
    volumes:
      - .:/app 
    environment:
      PYTHONUNBUFFERED: 1
      
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      CACHE_TTL: ${CACHE_TTL:-86400}
      
      API_KEYS: ${API_KEYS}
      
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4.1-mini}
      
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      SUPABASE_BUCKET: ${SUPABASE_BUCKET:-contact-scraper}
      
      DEBUG: ${DEBUG:-False}
      MAX_WORKERS: ${MAX_WORKERS:-2}
    env_file:
      - .env
    depends_on:
      - redis
    labels:
      # Traefik routing
      - traefik.enable=true
      - traefik.http.routers.contact-scraper.rule=Host(`scraper.hiscale.ai`)
      - traefik.http.routers.contact-scraper.entrypoints=websecure
      - traefik.http.routers.contact-scraper.tls=true
      - traefik.http.routers.contact-scraper.tls.certresolver=mytlschallenge
      # Optional security headers like n8n
      - traefik.http.middlewares.contact-scraper-headers.headers.SSLRedirect=true
      - traefik.http.middlewares.contact-scraper-headers.headers.STSSeconds=315360000
      - traefik.http.middlewares.contact-scraper-headers.headers.browserXSSFilter=true
      - traefik.http.middlewares.contact-scraper-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.contact-scraper-headers.headers.forceSTSHeader=true
      - traefik.http.routers.contact-scraper.middlewares=contact-scraper-headers@docker
    networks:
      - hiscale   # attaches to the same network as n8n Traefik

volumes:
  redis_data:

networks:
  hiscale:
    external: true   # uses existing n8n Traefik network
