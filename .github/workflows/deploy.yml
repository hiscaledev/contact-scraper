name: CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS host to known_hosts
        run: ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Test SSH connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: ssh "$VPS_USER@$VPS_HOST" "echo 'SSH connection successful'"

      - name: Sync repository to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
        run: |
          ssh "$VPS_USER@$VPS_HOST" "mkdir -p '$PROJECT_DIR'"
          rsync -az --delete \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '.env' \
            -e "ssh" \
            ./ "$VPS_USER@$VPS_HOST:$PROJECT_DIR"

      - name: Create .env file on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
          API_KEYS: ${{ secrets.API_KEYS }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_DB: ${{ secrets.REDIS_DB }}
          DEBUG: ${{ secrets.DEBUG }}
          MAX_WORKERS: ${{ secrets.MAX_WORKERS }}
          CACHE_TTL: ${{ secrets.CACHE_TTL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          cat > .env.tmp << EOF
          API_KEYS=$API_KEYS
          OPENAI_API_KEY=$OPENAI_API_KEY
          OPENAI_MODEL=$OPENAI_MODEL
          REDIS_PORT=$REDIS_PORT
          REDIS_DB=$REDIS_DB
          DEBUG=$DEBUG
          MAX_WORKERS=$MAX_WORKERS
          CACHE_TTL=$CACHE_TTL
          SUPABASE_URL=$SUPABASE_URL
          SUPABASE_KEY=$SUPABASE_KEY
          EOF
          
          scp .env.tmp "$VPS_USER@$VPS_HOST:$PROJECT_DIR/.env"
          ssh "$VPS_USER@$VPS_HOST" "chmod 600 '$PROJECT_DIR/.env'"
          rm .env.tmp

      - name: Deploy with Docker Compose on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
        run: |
          ssh "$VPS_USER@$VPS_HOST" "cd '$PROJECT_DIR' && docker compose pull || true"
          ssh "$VPS_USER@$VPS_HOST" "cd '$PROJECT_DIR' && docker compose down"
          ssh "$VPS_USER@$VPS_HOST" "cd '$PROJECT_DIR' && docker compose up -d --build --force-recreate"
          ssh "$VPS_USER@$VPS_HOST" "docker image prune -f || true"
          ssh "$VPS_USER@$VPS_HOST" "cd '$PROJECT_DIR' && docker compose ps"

      - name: Verify deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
        run: |
          sleep 15
          ssh "$VPS_USER@$VPS_HOST" "cd '$PROJECT_DIR' && docker compose ps"
          ssh "$VPS_USER@$VPS_HOST" "cd '$PROJECT_DIR' && docker compose ps | grep -q 'contact-scraper-v2.*Up' && echo 'App container is running' || (echo 'Error: App container is not running' && docker compose logs app && exit 1)"
          ssh "$VPS_USER@$VPS_HOST" "cd '$PROJECT_DIR' && docker compose ps | grep -q 'contact-scraper-redis-v2.*Up' && echo 'Redis container is running' || (echo 'Error: Redis container is not running' && docker compose logs redis && exit 1)"
          echo "Deployment verified successfully!"